<html>
<head>
<title>アニメーションのテスト</title>
<script type="text/javascript">
// <![CDATA[
window.onload = function(){
    //コンテキストの取得
    var canvas = document.getElementById("can");
    if(!canvas || !canvas.getContext) return false;
    var ctx = canvas.getContext("2d");
    ctx.fillStyle = "#ceceff";//描画色を指定
    
    //options
    var p = {minx:100,miny:100,maxx:500,maxy:400} //範囲の変数化
    var point = {x:300,y:250}; //球の座標
    var par = {x:3,y:2}; //変化量
    var mouse = 275; //マウスの座標(バーの座標)
    var N = 8; //破壊ブロック数
    var brock = new Array(N); //破壊フラグ格納変数
    for(i=0 ; i < N ; i++){ //破壊フラグの初期化
        brock[i] = 0;
    }
    var bwith = ((p.maxx-p.minx)-N*5-5)/N //破壊ブロックの幅
    var bhei = 10; //破壊ブロックの高さ
    var timer;//タイマー
    var delay = 20;//タイマーを実行する間隔
    
    //描画処理を行う関数。loop()関数の中で呼び出す。
    function draw(x,y){
        ctx.clearRect(0,0,600,500);//一度canvasをクリア
        ctx.fillStyle = 'rgb(240, 230, 140)';
        ctx.fillRect(100,100,400,300);
        ctx.strokeRect(100,100,400,300);
    
        ctx.beginPath(); //反射板(バー)
        ctx.fillStyle = 'rgb(139, 69, 19)';
        ctx.fillRect(mouse-30,380,50,10);
        ctx.stroke();

        ctx.beginPath(); //球
        ctx.fillStyle = 'rgb(255, 0, 0)';
        ctx.arc(x,y,5,0,Math.PI*2,true);
        ctx.fill();

        for(i=0;i<N;i++){ //破壊ブロックの配置
            if(brock[i] == 0){
                ctx.beginPath();
                ctx.fillStyle = 'rgb(0, 150, 0)';
                ctx.fillRect(p.minx+(i*5+5)+(i*bwith),p.miny+5+bhei,bwith,bhei);
            }
        }

    
    }
    //マウス移動時のX座標の取得
    canvas.addEventListener('mousemove', test);
    function test(e){
        mouse = e.clientX;
    }
    
    //繰り返し描画を行う関数。
    var loop = function(){
        
        //pointの数値をparの分だけ増やす
        if(point.x < 105 || point.x > 495){
            par.x *= (-1);
            if(point.y < 105){
                    par.y *= (-1);
            }else if(point.y == 380 && point.x >= mouse-25 && point.x <= mouse+25){
                    par.y *= (-1);
            }
        }else if(point.y < 105){
            par.y *= (-1);
            if(point.x < 105 || point.x > 495){
                 par.x *= (-1);
            }
        }else if(point.y == 380 && point.x >= mouse-25 && point.x <= mouse+25){
            par.y *= (-1);
            if(point.x < 105 || point.x > 495){
                 par.x *= (-1);
            }
        }else if(point.y == 400){
            par.x = par.y = 0;
        }
        point.x = point.x + par.x;
        point.y = point.y + par.y;
        //描画処理を呼び出す
        draw(point.x,point.y);
        //タイマー(一度クリアしてから再設定。)
        clearTimeout(timer);
        timer = setTimeout(loop,delay);
    }
    loop();
}
// ]]>
</script>
<style type="text/css" media="screen">

</style>

</head>

<body>
<div id="stage">
<canvas id="can" style="background-color:lightgray;" width="600" height="500"></canvas>
/* <![CDATA[ */
div#stage{
    top:50%;
    left:50%;
    margin-left:-300px;
    margin-top:-250px;
    background:#000;
}
/* ]]> */
</div>
</body>
</html>